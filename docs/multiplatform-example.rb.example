# å¤šå¹³å°é¢„ç¼–è¯‘åŒ… Formula ç¤ºä¾‹
# è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä¸ºä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œ CPU æ¶æ„æä¾›ä¸åŒçš„ä¸‹è½½åŒ…
# é€‚ç”¨åœºæ™¯ï¼šä½ çš„åº”ç”¨ä¸º macOS (arm64/x86_64) å’Œ Linux æä¾›äº†ä¸åŒçš„é¢„ç¼–è¯‘ç‰ˆæœ¬

class MultiplatformExample < Formula
  # åŸºæœ¬ä¿¡æ¯
  desc "A cross-platform command-line tool with architecture-specific builds"
  homepage "https://github.com/username/multiplatform-app"
  version "1.0.0"
  license "MIT"

  # ğŸ“¦ å¤šå¹³å°ä¸‹è½½é…ç½®
  # æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œ CPU æ¶æ„ï¼Œæä¾›ä¸åŒçš„ä¸‹è½½åœ°å€å’Œæ ¡éªŒå’Œ

  # macOS å¹³å°é…ç½®
  on_macos do
    # Apple Silicon (M1/M2/M3 ç­‰ ARM64 æ¶æ„)
    if Hardware::CPU.arm?
      url "https://github.com/username/multiplatform-app/releases/download/v#{version}/app-#{version}-macos-arm64.tar.gz"
      # ä½¿ç”¨å‘½ä»¤è·å–æ ¡éªŒå’Œï¼šshasum -a 256 app-1.0.0-macos-arm64.tar.gz
      sha256 "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
    # Intel Mac (x86_64 æ¶æ„)
    else
      url "https://github.com/username/multiplatform-app/releases/download/v#{version}/app-#{version}-macos-x86_64.tar.gz"
      # ä½¿ç”¨å‘½ä»¤è·å–æ ¡éªŒå’Œï¼šshasum -a 256 app-1.0.0-macos-x86_64.tar.gz
      sha256 "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
    end
  end

  # Linux å¹³å°é…ç½®
  on_linux do
    # ç›®å‰åªæ”¯æŒ x86_64 æ¶æ„çš„ Linux
    url "https://github.com/username/multiplatform-app/releases/download/v#{version}/app-#{version}-linux-x86_64.tar.gz"
    # ä½¿ç”¨å‘½ä»¤è·å–æ ¡éªŒå’Œï¼šshasum -a 256 app-1.0.0-linux-x86_64.tar.gz
    sha256 "cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc"

    # å¦‚æœä½ çš„ Linux ç‰ˆæœ¬ä¹Ÿæ”¯æŒ ARM64ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
    # if Hardware::CPU.arm?
    #   url "https://github.com/username/multiplatform-app/releases/download/v#{version}/app-#{version}-linux-arm64.tar.gz"
    #   sha256 "dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd"
    # else
    #   url "https://github.com/username/multiplatform-app/releases/download/v#{version}/app-#{version}-linux-x86_64.tar.gz"
    #   sha256 "cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc"
    # end
  end

  # ä¾èµ–å…³ç³»ï¼ˆå¯é€‰ï¼‰
  # å¦‚æœä½ çš„åº”ç”¨åœ¨ä¸åŒå¹³å°æœ‰ä¸åŒçš„ä¾èµ–ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
  # on_macos do
  #   depends_on "libffi"
  # end
  # on_linux do
  #   depends_on "glibc"
  # end

  # å®‰è£…æ–¹æ³•
  def install
    # å¯¹äºé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶åŒ…ï¼Œé€šå¸¸åªéœ€è¦å¤åˆ¶æ–‡ä»¶

    # å®‰è£…ä¸»ç¨‹åº
    bin.install "multiplatform-app"

    # å¦‚æœä¸åŒå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶åä¸åŒï¼Œå¯ä»¥è¿™æ ·å¤„ç†ï¼š
    # if OS.mac?
    #   bin.install "app-macos" => "multiplatform-app"
    # elsif OS.linux?
    #   bin.install "app-linux" => "multiplatform-app"
    # end

    # å®‰è£…åº“æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
    # lib.install Dir["lib/*"]

    # å®‰è£…æ–‡æ¡£
    # (share/"doc/multiplatform-app").install "README.md", "LICENSE"

    # å®‰è£…é…ç½®æ–‡ä»¶ç¤ºä¾‹
    # (etc/"multiplatform-app").install "config.example.toml"
  end

  # æµ‹è¯•æ–¹æ³•
  test do
    # æµ‹è¯•ç‰ˆæœ¬è¾“å‡º
    assert_match version.to_s, shell_output("#{bin}/multiplatform-app --version")

    # æµ‹è¯•å¸®åŠ©å‘½ä»¤
    system "#{bin}/multiplatform-app", "--help"

    # æ ¹æ®ä¸åŒå¹³å°è¿›è¡Œä¸åŒçš„æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    # if OS.mac?
    #   # macOS ç‰¹å®šæµ‹è¯•
    #   assert_match "macOS", shell_output("#{bin}/multiplatform-app --info")
    # elsif OS.linux?
    #   # Linux ç‰¹å®šæµ‹è¯•
    #   assert_match "Linux", shell_output("#{bin}/multiplatform-app --info")
    # end
  end
end

# ğŸ“ å¤šå¹³å° Formula ç¼–å†™è¦ç‚¹ï¼š
#
# 1ï¸âƒ£ URL å‘½åè§„èŒƒå»ºè®®ï¼š
#    - macOS ARM64: app-VERSION-macos-arm64.tar.gz
#    - macOS x86_64: app-VERSION-macos-x86_64.tar.gz
#    - Linux x86_64: app-VERSION-linux-x86_64.tar.gz
#    - Linux ARM64: app-VERSION-linux-arm64.tar.gz
#
# 2ï¸âƒ£ æ¡ä»¶åˆ¤æ–­è¯­æ³•ï¼š
#    - on_macos do ... end       # macOS å¹³å°
#    - on_linux do ... end       # Linux å¹³å°
#    - Hardware::CPU.arm?        # ARM æ¶æ„ï¼ˆApple Silicon, ARM64ï¼‰
#    - Hardware::CPU.intel?      # Intel æ¶æ„ï¼ˆx86_64ï¼‰
#    - OS.mac?                   # æ˜¯å¦ä¸º macOS
#    - OS.linux?                 # æ˜¯å¦ä¸º Linux
#
# 3ï¸âƒ£ SHA256 æ ¡éªŒå’Œè·å–ï¼š
#    å¯¹äºæ¯ä¸ªå¹³å°çš„åŒ…ï¼Œéƒ½éœ€è¦å•ç‹¬è®¡ç®— SHA256ï¼š
#    $ shasum -a 256 app-1.0.0-macos-arm64.tar.gz
#    $ shasum -a 256 app-1.0.0-macos-x86_64.tar.gz
#    $ shasum -a 256 app-1.0.0-linux-x86_64.tar.gz
#
# 4ï¸âƒ£ ç‰ˆæœ¬æ›´æ–°æµç¨‹ï¼š
#    1. æ›´æ–° version å­—æ®µ
#    2. ä¸‹è½½æ‰€æœ‰å¹³å°çš„æ–°ç‰ˆæœ¬åŒ…
#    3. è®¡ç®—æ‰€æœ‰åŒ…çš„ SHA256
#    4. æ›´æ–°æ‰€æœ‰çš„ sha256 å­—æ®µ
#    5. æµ‹è¯•å®‰è£…ï¼šbrew install --build-from-source ./Formula/xxx.rb
#
# 5ï¸âƒ£ æµ‹è¯•æ¸…å•ï¼š
#    â–¡ åœ¨ macOS ARM64 (Apple Silicon) ä¸Šæµ‹è¯•
#    â–¡ åœ¨ macOS x86_64 (Intel Mac) ä¸Šæµ‹è¯•ï¼ˆæˆ–ä½¿ç”¨ Rosettaï¼‰
#    â–¡ åœ¨ Linux x86_64 ä¸Šæµ‹è¯•
#    â–¡ è¿è¡Œ brew audit --strict æ£€æŸ¥è¯­æ³•
#    â–¡ è¿è¡Œ brew test éªŒè¯æµ‹è¯•é€šè¿‡
#
# 6ï¸âƒ£ å¸¸è§é™·é˜±ï¼š
#    âš ï¸  ç¡®ä¿ URL ä¸­çš„ #{version} å˜é‡æ­£ç¡®å¼•ç”¨
#    âš ï¸  ç¡®ä¿æ¯ä¸ªå¹³å°çš„ SHA256 å¯¹åº”æ­£ç¡®çš„åŒ…
#    âš ï¸  ä¸è¦åœ¨ URL å­—ç¬¦ä¸²ä¸­ä½¿ç”¨å•å¼•å·ï¼ˆåº”è¯¥ç”¨åŒå¼•å·ï¼‰
#    âš ï¸  ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
#    âš ï¸  å‹ç¼©åŒ…è§£å‹åçš„ç›®å½•ç»“æ„åº”è¯¥ä¸€è‡´
